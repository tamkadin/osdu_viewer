<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ entity_name }} Records - OSDU</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container fade-in">
        <div class="breadcrumb">
            <a href="/">üè† Home</a> / 
            <a href="/domain/{{ domain_name|urlencode }}">{{ domain_icon }} {{ domain_name }}</a> / 
            {{ entity_name }}
        </div>
        
        <h1 class="page-title">{{ entity_name }}</h1>
        <p><strong>M√¥ t·∫£:</strong> {{ entity_description }}</p>
        
        <div class="controls">
            <input type="number" id="limitInput" value="50" min="1" max="1000" placeholder="Limit" title="S·ªë l∆∞·ª£ng record hi·ªÉn th·ªã">
            <select id="fieldsSelect" title="D·ªØ li·ªáu hi·ªÉn th·ªã">
                <option value="">T√™n hi·ªÉn th·ªã</option>
                <option value="basic">T·∫•t c·∫£ d·ªØ li·ªáu</option>
            </select>
            <button class="btn btn-primary" onclick="loadRecords()">üîÑ Reload</button>
            <button class="btn" onclick="exportJSON()">üíæ Export JSON</button>
            <span id="totalCount" class="stat-label"></span>
        </div>
        
        <div class="stats" id="statsContainer" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="recordCount">0</div>
                <div class="stat-label">Records</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="currentPage">1</div>
                <div class="stat-label">Page</div>
            </div>
        </div>
        
        <div id="recordList" class="record-list">
            <div class="loading">
                <div class="spinner"></div>
                Loading records...
            </div>
        </div>
        
        <div id="pagination" class="pagination"></div>
    </div>

    <script>
        let currentOffset = 0;
        let currentLimit = 50;
        let totalCount = 0;
        let allRecords = [];
        
        async function loadRecords(offset = 0) {
            currentOffset = offset;
            currentLimit = parseInt(document.getElementById('limitInput').value) || 50;
            
            const recordList = document.getElementById('recordList');
            recordList.innerHTML = '<div class="loading"><div class="spinner"></div>Loading records...</div>';
            
            try {
                const fieldsSelect = document.getElementById('fieldsSelect').value;
                let url = `/api/records/{{ domain_name|urlencode }}/{{ entity_name|urlencode }}?limit=${currentLimit}&offset=${currentOffset}`;
                
                if (fieldsSelect && fieldsSelect !== '') {
                    url += `&fields=${fieldsSelect}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    recordList.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                    return;
                }
                
                totalCount = data.totalCount || 0;
                allRecords = data.results || [];
                
                document.getElementById('totalCount').textContent = `Total: ${totalCount} records`;
                document.getElementById('recordCount').textContent = totalCount;
                document.getElementById('currentPage').textContent = Math.floor(currentOffset / currentLimit) + 1;
                document.getElementById('statsContainer').style.display = 'grid';
                
                if (allRecords.length === 0) {
                    recordList.innerHTML = '<div class="loading">üì≠ No records found</div>';
                    return;
                }
                
                renderRecords(allRecords);
                updatePagination();
                
            } catch (error) {
                recordList.innerHTML = `<div class="error">‚ùå Error loading records: ${error.message}</div>`;
            }
        }
        
        function getDisplayName(record, entityName) {
            if (!record.data) return record.id;
            
            // Define name fields for each entity type
            const nameFields = {
                'Basin': ['BasinName', 'Name'],
                'GeologicFeature': ['GeologicFeatureName', 'Name'],
                'Field': ['FieldName', 'Name'],
                'IntervalSet': ['IntervalSetName', 'Name'],
                'Organization': ['OrganizationName', 'Name'],
                'ReferenceWellbore': ['WellboreName', 'Name'],
                'Well': ['WellName', 'Name'],
                'Wellbore': ['WellboreName', 'Name'],
                'WellLog': ['WellLogName', 'Name'],
                'WellTrajectory': ['WellTrajectoryName', 'Name'],
                'WorkProduct': ['WorkProductName', 'Name'],
                'WorkProductComponent': ['WorkProductComponentName', 'Name']
            };
            
            const fields = nameFields[entityName] || ['Name', 'name', 'title', 'Title'];
            
            for (let field of fields) {
                if (record.data[field]) {
                    return record.data[field];
                }
            }
            
            // Fallback: try first string field
            for (let key in record.data) {
                if (typeof record.data[key] === 'string' && record.data[key].length > 0) {
                    return record.data[key];
                }
            }
            
            return record.id.split(':').pop() || record.id;
        }
        
        function renderRecords(records) {
            const recordList = document.getElementById('recordList');
            const fieldsSelect = document.getElementById('fieldsSelect').value;
            
            recordList.innerHTML = '';
            
            records.forEach((record, index) => {
                const div = document.createElement('div');
                div.className = 'record-item card';
                div.style.animationDelay = `${index * 0.05}s`;
                div.classList.add('fade-in');
                div.onclick = () => viewRecord(record.id);
                
                const displayName = getDisplayName(record, '{{ entity_name }}');
                
                if (fieldsSelect === 'basic') {
                    // Show all data as preview
                    let jsonPreview = '';
                    if (record.data && Object.keys(record.data).length > 0) {
                        const previewData = {};
                        const dataKeys = Object.keys(record.data).slice(0, 3);
                        dataKeys.forEach(key => {
                            previewData[key] = record.data[key];
                        });
                        jsonPreview = `<div class="record-preview"><pre>${JSON.stringify(previewData, null, 2)}</pre></div>`;
                    }
                    
                    div.innerHTML = `
                        <div class="record-name">üìÑ ${displayName}</div>
                        <div class="record-kind-small">${record.kind || ''}</div>
                        ${jsonPreview}
                    `;
                } else {
                    // Simple display with just name
                    div.innerHTML = `
                        <div class="record-name-large">üìÑ ${displayName}</div>
                        <div class="record-subtitle">Click ƒë·ªÉ xem chi ti·∫øt</div>
                    `;
                }
                
                recordList.appendChild(div);
            });
        }
        
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            const totalPages = Math.ceil(totalCount / currentLimit);
            const currentPage = Math.floor(currentOffset / currentLimit) + 1;
            
            if (totalPages <= 1) return;
            
            // Previous button
            if (currentPage > 1) {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.innerHTML = '‚Äπ Previous';
                btn.onclick = () => loadRecords((currentPage - 2) * currentLimit);
                pagination.appendChild(btn);
            }
            
            // Page numbers
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.textContent = '1';
                btn.onclick = () => loadRecords(0);
                pagination.appendChild(btn);
                
                if (startPage > 2) {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.className = 'btn';
                    pagination.appendChild(span);
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const btn = document.createElement('button');
                btn.className = i === currentPage ? 'btn btn-primary active' : 'btn';
                btn.textContent = i;
                btn.onclick = () => loadRecords((i - 1) * currentLimit);
                pagination.appendChild(btn);
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.className = 'btn';
                    pagination.appendChild(span);
                }
                
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.textContent = totalPages;
                btn.onclick = () => loadRecords((totalPages - 1) * currentLimit);
                pagination.appendChild(btn);
            }
            
            // Next button
            if (currentPage < totalPages) {
                const btn = document.createElement('button');
                btn.className = 'btn';
                btn.innerHTML = 'Next ‚Ä∫';
                btn.onclick = () => loadRecords(currentPage * currentLimit);
                pagination.appendChild(btn);
            }
        }
        
        function viewRecord(recordId) {
            window.location.href = '/record/' + encodeURIComponent(recordId);
        }
        
        function exportJSON() {
            if (allRecords.length === 0) {
                alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t');
                return;
            }
            
            const dataStr = JSON.stringify(allRecords, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `{{ entity_name }}_records_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Event listeners
        document.getElementById('fieldsSelect').addEventListener('change', () => loadRecords());
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'r' && e.ctrlKey) {
                e.preventDefault();
                loadRecords();
            }
        });
        
        // Load initial records
        loadRecords();
    </script>
    
    <style>
        .field-preview {
            color: #6c757d;
            font-size: 0.85em;
        }
        
        .record-preview {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e9ecef;
        }
        
        .record-preview pre {
            font-size: 0.75em;
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 100px;
            overflow-y: auto;
        }
        
        code {
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .record-name-large {
            font-size: 1.2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .record-subtitle {
            color: #6c757d;
            font-size: 0.9em;
            font-style: italic;
        }
        
        .record-kind-small {
            color: #6c757d;
            font-size: 0.8em;
            margin-bottom: 4px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e9ecef;
            color: #495057;
            font-size: 0.85em;
            max-width: 150px;
            word-wrap: break-word;
        }
        
        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85em;
            max-width: 150px;
            word-wrap: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .data-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8em;
            border-radius: 4px;
        }
        
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.75em;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px 4px;
                max-width: 80px;
            }
        }
    </style>
</body>
</html>